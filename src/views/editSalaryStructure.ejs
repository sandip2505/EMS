<!DOCTYPE html>
<html lang="en">
<%- include('partials/header.ejs') %>

  <body>
    <div class="container-scroller">
      <%- include('partials/sidebar.ejs') %>
        <div class="container-fluid page-body-wrapper">
          <%- include('partials/navbar.ejs') %>
            <div class="main-panel">
              <div class="content-wrapper">
                <section class="content">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Edit Salary Structure</h3>
                    </div>
                    <div class="card-body">
                      <form method="post" action=""><br>
                        <div class="row">
                          <div class="col-4">
                            <label for="Name"> User Name: <span class="require">*</span></label>
                            <select class="form-control test" id="user" name="user_id">
                              <option value="">--Select User--</option>
                              <% if (userData) { %>
                                <% for(var i=0; i < userData.length; i++) { %>
                                  <%if(userData[i]._id.includes(existuserData._id)){%>
                                  <% isSelected='selected' %>

                                      <% }else{ %>
                                          <% isSelected='' %>
                                              <% } %>
                                  <option value="<%= userData[i]._id %>"   <%=isSelected %>>

                                    <%= userData[i].firstname %>
                                  </option>
                                  <% } %>

                                    <% } %>

                            </select>
                          </div>
                          <div class="col-4">
                            <label for="Name">Month: <span class="require">*</span></label>
                            <select id='gMonth2' name="month" class="form-control test">
                              <option value='' selected>--Select Month--</option>
                              <option value='1'>Janaury</option>
                              <option value='2'>February</option>
                              <option value='3'>March</option>
                              <option value='4'>April</option>
                              <option value='5'>May</option>
                              <option value='6'>June</option>
                              <option value='7'>July</option>
                              <option value='8'>August</option>
                              <option value='9'>September</option>
                              <option value='10'>October</option>
                              <option value='11'>November</option>
                              <option value='12'>December</option>
                            </select>
                          </div>
                          <div class="col-4">
                            <label for="Name">Year: <span class="require">*</span></label>
                            <select id='gyear' name="year" class="form-control test">
                              <option value='' selected>--Select Year--</option>
                              <option value='2022' <%= (salaryStructureData.year == '2022') ? 'selected=selected' : ''; %>  >2022</option>
                              <option value='2023' <%= (salaryStructureData.year == '2023') ? 'selected=selected' : ''; %> >2023</option>
                              <option value='2024' <%= (salaryStructureData.year == '2024') ? 'selected=selected' : ''; %>>2024</option>
                              <option value='2025' <%= (salaryStructureData.year == '2025') ? 'selected=selected' : ''; %>>2025</option>
                            </select>
                          </div>
                        </div>
                        <div class="row mt-3">
                          <div class="col-4">

                            <label for="Name"> Employee Code: <span class="require">*</span></label>
                            <input type="text" class="form-control text-white bg-dark" name="emp_code" id="emp_code"
                              placeholder="Your Employee Code" value="<%=existuserData.emp_code%>">
                          </div>
                          <div class="col-4">

                            <label for="Name"> Designation: <span class="require">*</span></label>
                            <input type="text" class="form-control text-white bg-dark" name="designation"
                              id="designation" placeholder="Your Working Day" value="<%=existuserData.emp_code%>">
                          </div>
                          <div class="col-4">
                            <label for="text"> Date Of Joining: <span class="require">*</span></label>
                            <% var DOJ =  new Date(existuserData.doj)%> 
                            <input type="text" class="form-control text-white bg-dark" name="doj" id="doj"
                              placeholder="Your present Day" value= "<%=DOJ.toISOString().split('T')[0].split("-").reverse().join("-")%>">
                          </div>
                          <!-- <div class="col-4">
                            <label for="Name"> Absent Day: <span class="require">*</span></label>
                            <input type="Number" class="form-control text-white bg-dark" name="absent_days"
                              id="absent_day" placeholder="Your absent Day">
                          </div> -->
                        </div>
                        <div class="row mt-3">
                          <div class="col-4">
                            <label for="Name"> Pan Number: <span class="require">*</span></label>
                            <input type="text" class="form-control text-white bg-dark" name="pan_number"
                              id="pan_number" placeholder="Your Leave Balance" value="<%=existuserData.pan_number%>">
                          </div>
                          <div class="col-4">
                            <label for="Name">Bank Name: <span class="require">*</span></label>
                            <input type="text" class="form-control text-white bg-dark" name="bank_name" id="bank_name"
                              placeholder="Enter Gross Salary" value="<%=existuserData.bank_name%>">
                          </div>
                          <div class="col-4">
                            <label for="Name"> Bank Account Number : <span class="require">*</span></label>
                            <input type="number" class="form-control text-white bg-dark" name="bank_account_no"
                              id="bank_account_no" placeholder="Enter Role Name" value="<%=existuserData.bank_account_no%>">
                          </div>
                        </div>
                          <div class="card-header">
                            <h3 class="card-title">Salary Particular</h3>
                          </div>
                          <div class="card-body">
                            <div class="row">
                              <div class="col-sm-6">
                                <div class="card">
                                  <div class="card-body">
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"><h4>Basic Salary:</h4>
                                        </div>
                                        <div class="col-6"><h4><input type="text" name="Basic_Salary" value="<%=salaryStructureData.Basic_Salary%>"></h4></div>
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"><h4>House Rent Allow:</h4>
                                        </div>
                                        <div class="col-6"><h4><input type="text" name="House_Rent_Allow" value="<%=salaryStructureData.House_Rent_Allow%>"></h4></div>
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"> <h4>Other Allownces:</h4>
                                        </div>
                                        <div class="col-6">
                                          <h4><input type="text" name="Other_Allownces" value="<%=salaryStructureData.Other_Allownces%>"></h4></div>
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"><h4>Performance Allownces :</h4>
                                        </div>
                                        <div class="col-6"><h4><input type="text" name="Performance_Allownces"  value="<%=salaryStructureData.Performance_Allownces%>">
                                         </h4></div>
                                      </div>
                                    </div>
      
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"><h4>Bonus :</h4>
                                        </div>
                                        <div class="col-6"> <h4><input type="text" name="Bonus"  value="<%=salaryStructureData.Bonus%>"></h4></div>
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"><h4>Other  :</h4>
                                        </div>
                                        <div class="col-6"> <h4><input type="text" name="Other"  value="<%=salaryStructureData.Other%>"></h4></div>
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <div class="row">
                                        <div class="col-6"><h4>EL Encash Amount   :</h4>
                                        </div>
                                        <div class="col-6"> <h4><input type="text" name="EL_Encash_Amount"  value="<%=salaryStructureData.EL_Encash_Amount%>"></h4></div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                          <div class="col-sm-6">
                            <div class="card">
                              <div class="card-body">
                                <div class="col-12">
                                  <div class="row">
                                    <div class="col-6"><h4>Professional Tax :</h4>
                                    </div>
                                    <div class="col-6"><h4><input type="text" name="Professional_Tax" value="<%=salaryStructureData.Professional_Tax%>"></h4></div>
                                  </div>
                                </div>
                                <div class="col-12">
                                  <div class="row">
                                    <div class="col-6"><h4>Income Tax:</h4>
                                    </div> 
                                    <div class="col-6"><h4><input type="text" name="Income_Tax" value="<%=salaryStructureData.Income_Tax%>"></h4></div>
                                  </div>
                                </div>
                                <div class="col-12">
                                  <div class="row">
                                    <div class="col-6"> <h4>Gratuity:</h4>
                                    </div>
                                    <div class="col-6">
                                      <h4><input type="text" name="Gratuity" value="<%=salaryStructureData.Gratuity%>"></h4></div>
                                  </div>
                                </div>
                                <div class="col-12">
                                  <div class="row">
                                    <div class="col-6"><h4>Provident Fund:</h4>
                                    </div>
                                    <div class="col-6"><h4><input type="text" name="Provident_Fund" value="<%=salaryStructureData.Provident_Fund%>">
                                     </h4></div>
                                  </div>
                                </div>
  
                                <div class="col-12">
                                  <div class="row">
                                    <div class="col-6"><h4>ESIC :</h4>
                                    </div>
                                    <div class="col-6"> <h4><input type="text" name="ESIC" value="<%=salaryStructureData.ESIC%>"></h4></div>
                                  </div>
                                </div>
                                <div class="col-12">
                                  <div class="row">
                                    <div class="col-6"><h4>Other Deduction:</h4>
                                    </div>
                                    <div class="col-6"> <h4><input type="text" name="Other_Deduction" value="<%=salaryStructureData.Other_Deduction%>"></h4></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          </div>
                          </div>
                        <div class="col-12 mt-5">
                          <button type="submit" name="submit" id="submit" class="btn btn-primary">Submit</button>
                          <a class="btn btn-danger" href="/salaryStructureListing">Back</a>
                        </div>
                      </form>
                    </div>
                  </div>
                </section>
              </div>
              <%- include('partials/footer.ejs') %>
  </body>

</html>
<!-- <script>

  $(document).ready(function () {
    $('#myTable').DataTable();
  });

  function openModal(modal_id) {
    //$('.confirm-delete').addClass('hide');
    $('#myModal_' + modal_id + '.modal-header, .modal-footer, .modal-body').removeClass('hide');
    $('#myModal_' + modal_id).modal('show');
  }




  $(document).ready(function () {
    $('.test').change(function () {
      var month = $('#gMonth2').val();
      var user = $('#user').val();
      var year = $('#gyear').val();
      var input = { user: user, month: month, year: year }

      if (user && month && year !== '') {
        console.log(input)
        callLeaves(input);
      } else {
        // console.log(false);
      }
    })
    function callLeaves(data) {
      $.ajax({
        type: "POST",
        url: "/api/getLeaveBalance",
        data: data,
        dataType: "json",
        success: function (response) {

          var takenLeaves = response.totalTakenLeaves

          $.ajax({
            type: "POST",
            url: "/api/getWorkingDay",
            data: data,
            dataType: "json",
            success: function (response) {

              var holidaysInMonth = response.holidayData.length
              $.ajax({
                type: "POST",
                url: "/api/getDataByUser",
                data: data,
                dataType: "json",
                success: function (response) {
                  // var holidaysInMonth = response.holidayData.length
                  $("#absent_day").html('');

                  let leave = 0;
                  var totaldate = []
                  $.map(response.userLeavesData, function (val, i) {
                    const DF = new Date(val.datefrom)
                    const DT = new Date(val.dateto)
                    const this_month = parseInt(data.month); // match dates in April (4th month)
                    var days_difference = 0;

                    for (let d = DF; d <= DT; d.setDate(d.getDate() + 1)) {
                      if (d.getMonth() + 1 === this_month) {
                        days_difference += 1;
                      }
                    }

                   
                    if (days_difference > 0) {
                      totaldate.push(days_difference);
                    }
                  });
  

                  totaldate.forEach(item => {
                    leave += item;
                  });
                  const this_month = parseInt(data.month)
                  const this_year = parseInt(data.year)

                  const daysInMonth = getDaysInMonth(this_year, this_month);
                  $("#total_day").val(daysInMonth);
                  const sundaysInMonth = getSundaysInMonth(this_year, this_month);


                  $("#absent_day").val(leave);
                  $("#working_day").val(daysInMonth - sundaysInMonth - holidaysInMonth)
                  var presentday = (daysInMonth - sundaysInMonth - holidaysInMonth - leave)
                  $("#present_day").val(presentday)
                  var toltalLeaves = "<%= leaves %>"

                  $("#leave_balance").val(toltalLeaves - takenLeaves);

                },
              });
            }
          })
        }
      })
    }
  });
  function getDaysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
  }
  function getSundaysInMonth(year, month) {
    const date = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0).getDate();
    let count = 0;
    for (let i = 1; i <= lastDay; i++) {
      date.setDate(i);
      if (date.getDay() === 0) {
        count++;
      }
    }
    return count;
  }




</script> -->
<script>
  // alert(user)
  $("#user").change(function () {
    var user = $('#user').val()
    $.ajax({
      type: "POST",
      url: "/api/getUserData",
      data: { 'user': user },
      dataType: "json",
      success: function (response) {
        var emp_code = response.UserData.emp_code;
        var role = response.UserData.roleName;
        var DOJ = response.UserData.doj
        let dateofjoining=new Date(response.UserData.doj) 
        let pan_Number = response.UserData.pan_number
        let bank_name = response.UserData.bank_name
        let bank_account_no = response.UserData.bank_account_no 

          $('#emp_code').val(emp_code)
          $('#designation').val(role)
          $('#doj').val(dateofjoining.toISOString().split('T')[0].split("-").reverse().join("-"))
          $('#pan_number').val(pan_Number)
          $('#bank_name').val(bank_name)
          $('#bank_account_no').val(bank_account_no)

      }
    })
  })
</script>