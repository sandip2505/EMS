<!DOCTYPE html>
<html lang="en">
<%- include('partials/header.ejs') %>


  <body>
    <div class="container-scroller">
      <%- include('partials/sidebar.ejs') %>
        <div class="container-fluid page-body-wrapper">
          <%- include('partials/navbar.ejs') %>
            <div class="main-panel">
              <div class="content-wrapper">
                <section class="content">
                  <div class="container-fluid">
                    <div class="row">
                      <div class="col-12">
                        <div class="card">
                          <div>
                            
                            <select class="col-2 form-control ml-2" onchange="filterData()"style="float:right"  id="year" name="year">
                              <option value="" selected="true">Select Year</option>
                              <option value="2022-2023">2022-2023</option>
                              <option value="2023-2024">2023-2024</option>
                              <option value="2024-2025">2024-2025</option>
                            </select>
                          </div>

                          <div class="card-body">
                            <table class="table" id="myTable">
                              <thead>
                                <tr>
                                  <th>#</th>
                                  <th>Name</th>
                                  <th>total leaves</th>

                                  <th>taken leaves</th>
                                  <th>left leaves</th>

                                </tr>
                              </thead>
                              <tbody id="userLeaves">
                                <% const totaldate=[] %>

                                  <% let days_difference=0 %>

                                    <% if (employeeData) { %>
                                      <% var i=1; %>
                                        <% employeeData.forEach(function(u) { %>
                                          <% let sum=0; %>
                                            <tr>
                                              <td>
                                                <%= i++ %>
                                              </td>
                                              <td>
                                                <%= u.firstname %>
                                              </td>


                                              <td>
                                                <%=leaves %>
                                              </td>


                                              <% u.leaves.forEach(function(r) { %>

                                                <% if(r.status=="APPROVED" ) { %>

                                                  <% const DF=new Date(r.datefrom) %>
                                                    <% const DT=new Date(r.dateto)
                                                     const oneDay=24 * 60 * 60 * 1000;
                                                      <!-- const diffDays=Math.round(Math.abs((DT - DF) / oneDay)) + 1; -->
                                                      if(r.half_day ==""){
                                                        var diffDays = Math.round(Math.abs((DT - DF) / oneDay)) + 1; // Adding 1 to include both start and end dates
                                                    }else{
                                                        var diffDays = Math.round(Math.abs((DT - DF) / oneDay)) + 1/2; 
                                                    }
                                                      let sundayCount = 0;
                                                      for (let i = 0; i < diffDays; i++) {
                                                          const currentDate = new Date(DF.getTime() + (i * oneDay));
                                                          if (currentDate.getDay() === 0) {
                                                              sundayCount++;
                                                          }
                                                      }
                                                      var totalLeaveDay = diffDays - sundayCount

                                                      sum+=totalLeaveDay; %>
                                                      <% } %>
                                                        <% }) %>

                                                          <td>
                                                            <%= sum %>
                                                          </td>
                                                          <td>
                                                            <%= leaves - sum %>
                                                          </td>
                                                          <% }) %>
                                                            <% } %>

                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <%- include('partials/footer.ejs') %>

  </body>

</html>
<script>
  $(document).ready(function () {
    $('#myTable').DataTable();
  });

  function openModal(modal_id) {
    //$('.confirm-delete').addClass('hide');
    $('#myModal_' + modal_id + '.modal-header, .modal-footer, .modal-body').removeClass('hide');
    $('#myModal_' + modal_id).modal('show');
  }

  function filterData(){
        var year = $('#year').val();
        var data = {};
        if (year) {
            data.year = year;
        }
        $('#myTable').DataTable().destroy();
    
    $.ajax({
        type: "post",
        url: "/api/filterallUserLeaves/",
        data: data,
        success: function (response) {
          $('#userLeaves').html('')
          $.map(response.userData, function (user, i) {
            const totalLeaves =  "<%=leaves %>"
            const leftLeaves = totalLeaves- user.takenLeaves
            $('#userLeaves').append('<tr id = "' + user._id + '"> <td>' + ++i + '</td> <td>' + user.firstname + '</td> <td>' + totalLeaves + '</td>  <td>' + user.takenLeaves + '</td> <td>' + leftLeaves + '</td> </tr>')
          })
          $('#myTable').DataTable()
        }
      })
    }


</script>